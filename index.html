<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
    <title>KietSound Pro - AI Music Studio</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#090A0C">

    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Outfit:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { primary: "#FF6F61", "bg-dark": "#090A0C" },
                    fontFamily: { sans: ["Inter", "sans-serif"], display: ["Outfit", "sans-serif"] },
                },
            },
        };
    </script>

    <style type="text/tailwindcss">
        body { background-color: #090A0C; color: #e2e8f0; overscroll-behavior-y: none; }
        
        /* Glassmorphism Card */
        .glass-card { 
            background: rgba(23, 25, 30, 0.95); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }

        /* Chips / Tags */
        .chip-option { 
            @apply px-3 py-1.5 rounded-lg text-[11px] font-bold border border-white/10 text-slate-400 bg-white/5 cursor-pointer hover:bg-white/10 whitespace-nowrap transition-all select-none; 
        }
        .chip-option.active { 
            @apply bg-primary text-white border-primary shadow-lg shadow-primary/30; 
        }

        /* Scrollbar An/Hien */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

        /* Sliders */
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #FF6F61; margin-top: -6px; border: 2px solid white; box-shadow: 0 0 10px rgba(255,111,97,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 10px; }

        /* Animation */
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }
        
        .scan-line { height: 2px; background: linear-gradient(to right, transparent, #FF6F61, transparent); position: absolute; width: 100%; top: 0; animation: scan 3s linear infinite; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
    </style>
</head>
<body class="bg-bg-dark min-h-screen pb-32 font-sans selection:bg-primary selection:text-white">

<nav class="sticky top-0 z-50 px-4 py-3 glass-card border-b border-white/5 mb-6">
    <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
        <div class="flex items-center gap-2">
            <div class="bg-primary p-1.5 rounded-lg shadow-lg shadow-primary/20"><span class="material-icons-round text-white text-xl">equalizer</span></div>
            <span class="text-xl font-display font-bold text-white uppercase tracking-tight">Kiet<span class="text-primary">Sound</span></span>
        </div>
        <div class="flex items-center gap-3">
            <div class="hidden sm:flex flex-col text-right max-w-[170px]">
                <span class="text-[10px] uppercase text-slate-500 font-bold tracking-wide">Account</span>
                <span id="user-display" class="text-xs font-bold text-white truncate">Guest</span>
            </div>
            <button id="login-btn" class="px-4 py-2 rounded-xl text-xs font-bold bg-white/10 hover:bg-white/20 text-white border border-white/10 transition-all">
                LOGIN
            </button>
            <div class="flex gap-1 bg-white/5 p-1 rounded-2xl">
                <button onclick="showView('dashboard')" id="nav-dashboard" class="px-5 py-2 rounded-xl text-xs font-bold transition-all bg-white/10 text-white shadow-sm">HOME</button>
                <button onclick="showView('studio')" id="nav-studio" class="px-5 py-2 rounded-xl text-xs font-bold text-slate-400 hover:text-white transition-all">STUDIO</button>
            </div>
        </div>
    </div>
</nav>

<main class="max-w-7xl mx-auto px-4">
    
    <div id="view-dashboard" class="grid lg:grid-cols-12 gap-6 animate-fade-in">
        <section class="lg:col-span-5 space-y-4">
            <div class="aspect-[4/3] rounded-[2rem] overflow-hidden glass-card relative bg-black shadow-2xl border border-white/10 group">
                <video id="video" autoplay playsinline class="w-full h-full object-cover opacity-80 transition-opacity group-hover:opacity-100"></video>
                <canvas id="canvas" class="hidden"></canvas>
                
                <div id="scan-effect" class="absolute inset-0 pointer-events-none opacity-50"><div class="scan-line"></div></div>
                
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent flex flex-col justify-end p-6">
                    <button id="analyze-btn" class="w-full bg-primary text-white py-4 rounded-2xl font-bold shadow-xl shadow-primary/30 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <span class="material-icons-round">face_retouching_natural</span> ANALYZE MOOD
                    </button>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6 flex justify-between items-center border-l-4 border-primary">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Detected Mood</p>
                    <h2 id="mood-display" class="text-3xl font-display font-bold text-white uppercase">Ready</h2>
                </div>
                <div class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center">
                    <span class="material-icons-round text-primary text-2xl animate-pulse">sensors</span>
                </div>
            </div>
        </section>

        <section class="lg:col-span-7 space-y-4">
            <div class="glass-card rounded-2xl p-2 pl-4 flex items-center gap-3 border border-white/10 focus-within:border-primary/50 transition-colors">
                <span class="material-icons-round text-slate-500">search</span>
                <input id="search-input" class="flex-1 bg-transparent border-none focus:ring-0 text-white h-10 placeholder-slate-600 font-medium" placeholder="Tìm bài hát Youtube..."/>
                <button onclick="performSearch()" class="bg-white text-black px-6 py-2.5 rounded-xl font-bold text-sm hover:bg-slate-200 transition-colors">GO</button>
            </div>
            <div class="flex gap-2">
                <button id="type-music" onclick="switchType('music')" class="flex-1 py-3 rounded-xl font-bold text-xs bg-primary text-white shadow-lg transition-all flex items-center justify-center gap-2"><span class="material-icons-round text-sm">music_note</span> MUSIC</button>
                <button id="type-podcast" onclick="switchType('podcast')" class="flex-1 py-3 rounded-xl font-bold text-xs bg-white/5 text-slate-400 transition-all flex items-center justify-center gap-2"><span class="material-icons-round text-sm">podcasts</span> PODCAST</button>
            </div>
            
            <div class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-2">
                <span class="text-xs font-bold text-slate-500 px-2">TRENDING:</span>
                <button onclick="document.getElementById('search-input').value='Chill Lofi'; performSearch()" class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-[10px] font-bold text-slate-300 hover:bg-white/10">#Lofi</button>
                <button onclick="document.getElementById('search-input').value='Nhạc trẻ remix'; performSearch()" class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-[10px] font-bold text-slate-300 hover:bg-white/10">#Remix</button>
                <button onclick="document.getElementById('search-input').value='Piano Focus'; performSearch()" class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-[10px] font-bold text-slate-300 hover:bg-white/10">#Piano</button>
            </div>

            <div id="recommendations-container" class="space-y-3 pb-4 max-h-[500px] overflow-y-auto custom-scrollbar">
                <div class="text-center py-20 opacity-30">
                    <span class="material-icons-round text-6xl mb-2">queue_music</span>
                    <p class="text-sm font-bold">Search or Scan Mood to start</p>
                </div>
            </div>
        </section>
    </div>

    <div id="view-studio" class="hidden grid lg:grid-cols-12 gap-6 animate-fade-in">
        <div class="lg:col-span-8 space-y-6">
            <div class="glass-card rounded-[2rem] p-6 md:p-8 border border-white/10">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-display font-bold text-white flex items-center gap-2">
                        <span class="material-icons-round text-primary">auto_fix_high</span> AI Generator
                    </h2>
                    <span class="px-3 py-1 rounded-full bg-primary/20 text-primary text-xs font-bold border border-primary/20">Pro Mode</span>
                </div>
                
                <div class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Tên bài hát</label>
                                <input id="gen-title" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-primary focus:ring-0 transition-colors placeholder-slate-600" placeholder="Đặt tên cho tác phẩm...">
                            </div>
                            <div class="p-4 rounded-xl bg-white/5 border border-white/5">
                                <p class="text-[10px] text-slate-400 uppercase font-bold mb-2">Quick Tips</p>
                                <ul class="text-xs text-slate-300 space-y-1 list-disc pl-4">
                                    <li>Mỗi dòng là một câu hát (Bar).</li>
                                    <li>Dùng dấu chấm để ngắt nghỉ.</li>
                                    <li>Chọn Tempo phù hợp với độ dài câu.</li>
                                </ul>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Lyrics (Lời bài hát)</label>
                            <textarea id="gen-lyrics" rows="8" class="w-full h-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white font-mono text-sm focus:border-primary focus:ring-0 transition-colors placeholder-slate-600 resize-none leading-relaxed" 
                            placeholder="Nhập lời bài hát vào đây...&#10;Xuống dòng để AI bắt nhịp tốt hơn...&#10;&#10;Ví dụ:&#10;Hôm nay trời đẹp quá&#10;Em có muốn đi chơi không?"></textarea>
                        </div>
                    </div>

                    <div class="h-px bg-white/10 w-full"></div>

                    <div class="space-y-5">
                        <div>
                            <div class="flex justify-between items-end mb-2">
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider block ml-1"># Style (70+)</label>
                                <span class="text-[10px] text-primary cursor-pointer hover:underline" onclick="resetChips()">Reset All</span>
                            </div>
                            <div class="flex flex-wrap gap-2 max-h-32 overflow-y-auto custom-scrollbar p-1" id="style-options"></div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1"># Moods</label>
                            <div class="flex flex-wrap gap-2" id="mood-options"></div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1"># Voices</label>
                                <div class="flex flex-wrap gap-2" id="voice-options"></div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1"># Tempos</label>
                                <div class="flex flex-wrap gap-2" id="tempo-options"></div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button id="generate-btn" onclick="generateMusic()" class="group w-full bg-gradient-to-r from-primary to-orange-600 text-white py-4 rounded-xl font-bold text-lg shadow-xl shadow-primary/20 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                            <span class="material-icons-round group-hover:animate-spin">album</span> GENERATE TRACK
                        </button>
                        <p id="gen-status" class="text-center text-xs text-primary font-bold h-4 mt-3 opacity-0 transition-opacity"></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-4 space-y-4">
            <div class="glass-card rounded-[2rem] p-6 h-[85vh] flex flex-col sticky top-24">
                <div class="flex items-center justify-between mb-4 border-b border-white/5 pb-4">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <span class="material-icons-round text-primary">library_music</span> My Library
                    </h3>
                    <span id="library-count" class="px-2 py-0.5 bg-white/10 rounded text-[10px] font-bold">0 songs</span>
                </div>
                
                <div id="my-songs-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                    <div class="flex flex-col items-center justify-center h-40 opacity-50">
                        <span class="material-icons-round text-4xl mb-2">hourglass_empty</span>
                        <p class="text-xs">Loading library...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="player-bar" class="fixed bottom-0 left-0 w-full z-[100] glass-card border-t border-white/10 hidden pb-safe-bottom bg-[#090A0C]/95 transition-transform duration-300 transform translate-y-full">
    <div class="relative w-full h-1 bg-white/10 cursor-pointer group">
        <div id="progress-fill" class="h-full bg-primary w-0 relative">
            <div class="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow opacity-0 group-hover:opacity-100 transition-opacity"></div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto flex items-center justify-between gap-4 p-3 md:p-4">
        <div class="flex items-center gap-3 min-w-0 w-1/3">
            <div class="relative w-12 h-12 flex-shrink-0 group">
                <img id="player-thumb" class="w-full h-full rounded-xl bg-black/50 object-cover border border-white/10" src="https://via.placeholder.com/40">
                <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center rounded-xl">
                    <span class="material-icons-round text-white text-sm">open_in_full</span>
                </div>
            </div>
            <div class="min-w-0">
                <div id="player-title-container" class="w-full overflow-hidden">
                    <p id="player-title" class="text-sm font-bold text-white truncate">Select a song</p>
                </div>
                <p id="player-desc" class="text-[10px] text-slate-400 font-medium uppercase tracking-wide truncate">Ready</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <button class="text-slate-400 hover:text-white transition-colors hidden md:block"><span class="material-icons-round">skip_previous</span></button>
            <button id="play-btn" onclick="toggleMainPlay()" class="w-12 h-12 bg-white text-black rounded-full flex items-center justify-center shadow-lg hover:scale-105 active:scale-95 transition-all">
                <span id="play-icon" class="material-icons-round text-2xl">play_arrow</span>
            </button>
            <button class="text-slate-400 hover:text-white transition-colors hidden md:block"><span class="material-icons-round">skip_next</span></button>
        </div>

        <div class="flex items-center justify-end gap-3 w-1/3">
            <div class="hidden md:flex items-center gap-2 group">
                <span class="material-icons-round text-slate-500 text-xs">volume_up</span>
                <input type="range" class="w-20 accent-primary h-1" min="0" max="100" value="100" oninput="setVolume(this.value)">
            </div>
            <a id="download-btn" href="#" download class="p-2 text-slate-400 hover:text-primary transition-colors hidden" title="Download MP3">
                <span class="material-icons-round">download</span>
            </a>
        </div>
    </div>
</div>

<audio id="local-audio" class="hidden" onended="onTrackEnded()" ontimeupdate="onTrackUpdate()"></audio>
<div id="yt-player-hidden" class="fixed top-0 left-0 opacity-0 pointer-events-none w-1 h-1"></div>

<script>
    // ==========================================
    // 1. DATA CONFIGURATION (FULL LIST)
    // ==========================================
    const OPTS = {
        styles: [
            "Pop", "Rock", "Punk", "Electronic", "Rap", "Metal", "Hard Rock", 
            "Alternative", "Funk", "Pop Rock", "Pop Punk", "Swing", "Dark Folk", 
            "Lo-Fi", "Sad Rap", "Dubstep", "EDM", "Ballad", "R&B", "Jazz", "Blues",
            "Country", "Soul", "Reggae", "Latin", "House", "Techno", "Trance", "Indie"
        ],
        moods: [
            "Joy", "Sadness", "Anger", "Fear", "Surprise", "Anticipation", 
            "Calmness", "Romantic", "Nostalgia", "Triumph"
        ],
        voices: [
            "Soprano", "Alto", "Tenor", "Bass", "Male", "Female"
        ],
        tempos: [
            "Fast", "Medium", "Slow"
        ]
    };

    // State Variables
    let genState = { style: 'Pop', mood: 'Joy', voice: 'Female', tempo: 'Medium' };
    let currentMode = 'local'; // 'local' | 'youtube'
    let currentType = 'music'; // 'music' | 'podcast'
    let ytPlayer;
    let isYtReady = false;
    let localAudio = document.getElementById('local-audio');

    // ==========================================
    // 2. UI INITIALIZATION & CHIPS
    // ==========================================
    function initUI() {
        renderChips('style-options', OPTS.styles, 'style');
        renderChips('mood-options', OPTS.moods, 'mood');
        renderChips('voice-options', OPTS.voices, 'voice');
        renderChips('tempo-options', OPTS.tempos, 'tempo');
        
        loadMySongs();
        initCamera();
        
        // Setup default view
        showView('dashboard');
    }

    function renderChips(containerId, dataArray, key) {
        const container = document.getElementById(containerId);
        container.innerHTML = dataArray.map(item => 
            `<div onclick="selectChip('${key}', '${item}')" 
                  class="chip-option ${genState[key] === item ? 'active' : ''}" 
                  data-group="${key}" 
                  data-value="${item}">
                ${item}
            </div>`
        ).join('');
    }

    window.selectChip = (key, value) => {
        genState[key] = value;
        // Update UI classes
        document.querySelectorAll(`[data-group="${key}"]`).forEach(el => {
            if (el.dataset.value === value) el.classList.add('active');
            else el.classList.remove('active');
        });
    };

    window.resetChips = () => {
        genState = { style: 'Pop', mood: 'Joy', voice: 'Female', tempo: 'Medium' };
        initUI(); // Re-render
    };

    window.showView = (viewName) => {
        const dash = document.getElementById('view-dashboard');
        const studio = document.getElementById('view-studio');
        const navDash = document.getElementById('nav-dashboard');
        const navStudio = document.getElementById('nav-studio');

        if (viewName === 'dashboard') {
            dash.classList.remove('hidden');
            studio.classList.add('hidden');
            navDash.classList.replace('text-slate-400', 'bg-white/10');
            navDash.classList.add('text-white');
            navStudio.classList.replace('bg-white/10', 'text-slate-400');
            navStudio.classList.remove('text-white');
        } else {
            dash.classList.add('hidden');
            studio.classList.remove('hidden');
            navStudio.classList.replace('text-slate-400', 'bg-white/10');
            navStudio.classList.add('text-white');
            navDash.classList.replace('bg-white/10', 'text-slate-400');
            navDash.classList.remove('text-white');
            loadMySongs(); // Refresh library
        }
    };

    window.switchType = (type) => {
        currentType = type;
        const musicBtn = document.getElementById('type-music');
        const podcastBtn = document.getElementById('type-podcast');

        if (type === 'music') {
            musicBtn.classList.add('bg-primary', 'text-white', 'shadow-lg');
            musicBtn.classList.remove('bg-white/5', 'text-slate-400');
            podcastBtn.classList.remove('bg-primary', 'text-white', 'shadow-lg');
            podcastBtn.classList.add('bg-white/5', 'text-slate-400');
        } else {
            podcastBtn.classList.add('bg-primary', 'text-white', 'shadow-lg');
            podcastBtn.classList.remove('bg-white/5', 'text-slate-400');
            musicBtn.classList.remove('bg-primary', 'text-white', 'shadow-lg');
            musicBtn.classList.add('bg-white/5', 'text-slate-400');
        }

        const query = document.getElementById('search-input').value.trim();
        if (query) performSearch();
    };

    // ==========================================
    // 3. MUSIC GENERATION LOGIC
    // ==========================================
    async function generateMusic() {
        const title = document.getElementById('gen-title').value;
        const lyrics = document.getElementById('gen-lyrics').value;
        const btn = document.getElementById('generate-btn');
        const status = document.getElementById('gen-status');

        if (!lyrics.trim()) {
            alert("Vui lòng nhập lời bài hát (Lyrics)!");
            document.getElementById('gen-lyrics').focus();
            return;
        }

        // Loading State
        btn.disabled = true;
        btn.classList.add('opacity-70', 'cursor-not-allowed');
        btn.innerHTML = `<span class="material-icons-round animate-spin">autorenew</span> PROCESSING...`;
        status.style.opacity = '1';
        status.innerText = "AI đang xử lý giọng hát & phối khí...";

        const formData = new FormData();
        formData.append('title', title.trim() || "Untitled Song");
        formData.append('lyrics', lyrics);
        formData.append('style', genState.style);
        formData.append('mood', genState.mood);
        formData.append('voice', genState.voice);
        formData.append('tempo', genState.tempo);

        try {
            const response = await fetch('/generate-music', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.status === 'success') {
                status.innerText = "Hoàn tất!";
                status.classList.replace('text-primary', 'text-green-500');
                
                await loadMySongs();
                playTrack(data.song, 'local');
            } else {
                status.innerText = "Lỗi: " + data.message;
            }
        } catch (error) {
            console.error(error);
            status.innerText = "Lỗi kết nối đến Server.";
        } finally {
            // Reset Button
            setTimeout(() => {
                btn.disabled = false;
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
                btn.innerHTML = `<span class="material-icons-round">album</span> GENERATE TRACK`;
                status.style.opacity = '0';
                status.classList.replace('text-green-500', 'text-primary');
            }, 2000);
        }
    }

    // ==========================================
    // 4. LIBRARY MANAGEMENT
    // ==========================================
    async function loadMySongs() {
        const listContainer = document.getElementById('my-songs-list');
        const countBadge = document.getElementById('library-count');
        
        try {
            const res = await fetch('/my-songs');
            const songs = await res.json();
            
            countBadge.innerText = `${songs.length} songs`;

            if (songs.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 opacity-40">
                        <span class="material-icons-round text-4xl mb-2">library_music</span>
                        <p class="text-xs">Chưa có bài hát nào.</p>
                    </div>`;
                return;
            }

            listContainer.innerHTML = songs.map(song => `
                <div class="group relative p-3 rounded-xl bg-white/5 hover:bg-white/10 border border-transparent hover:border-white/10 transition-all cursor-pointer flex items-center justify-between"
                     onclick='playTrack(${JSON.stringify(song)}, "local")'>
                    
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center text-white font-bold text-xs flex-shrink-0">
                            AI
                        </div>
                        <div class="min-w-0">
                            <h4 class="font-bold text-sm text-white truncate group-hover:text-primary transition-colors">${song.title}</h4>
                            <div class="flex gap-2 text-[10px] text-slate-400">
                                <span class="bg-black/20 px-1.5 rounded">${song.style}</span>
                                <span class="bg-black/20 px-1.5 rounded">${song.mood}</span>
                            </div>
                        </div>
                    </div>

                    <button onclick="event.stopPropagation(); deleteSong('${song.file_url}')" 
                            class="w-8 h-8 rounded-full hover:bg-red-500/20 text-slate-500 hover:text-red-500 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all">
                        <span class="material-icons-round text-sm">delete</span>
                    </button>
                </div>
            `).join('');
            
        } catch (e) {
            console.error("Load library failed", e);
        }
    }

    async function deleteSong(url) {
        if (!confirm("Bạn có chắc chắn muốn xóa bài hát này?")) return;
        try {
            await fetch(`/my-songs/delete?url=${url}`, { method: 'DELETE' });
            loadMySongs();
        } catch (e) { alert("Xóa thất bại"); }
    }

    // ==========================================
    // 5. PLAYER LOGIC (Unified Local + Youtube)
    // ==========================================
    function playTrack(data, mode) {
        const playerBar = document.getElementById('player-bar');
        const pTitle = document.getElementById('player-title');
        const pDesc = document.getElementById('player-desc');
        const pThumb = document.getElementById('player-thumb');
        const playIcon = document.getElementById('play-icon');
        const dlBtn = document.getElementById('download-btn');

        // Show player
        playerBar.classList.remove('hidden', 'translate-y-full');
        
        currentMode = mode;

        if (mode === 'local') {
            // STOP Youtube
            if (isYtReady && ytPlayer.stopVideo) ytPlayer.stopVideo();

            // Setup UI
            pTitle.innerText = data.title;
            pDesc.innerText = `AI Generated • ${data.style} • ${data.mood}`;
            pThumb.src = "https://cdn-icons-png.flaticon.com/512/12204/12204300.png"; // AI Icon
            dlBtn.href = data.file_url;
            dlBtn.classList.remove('hidden');

            // Play Audio
            localAudio.src = data.file_url;
            localAudio.play();
            playIcon.innerText = "pause";

        } else if (mode === 'youtube') {
            // STOP Local
            localAudio.pause();
            
            // Setup UI
            pTitle.innerText = data.title;
            pDesc.innerText = "Youtube Music";
            pThumb.src = data.thumbnail;
            dlBtn.classList.add('hidden');

            // Play Youtube
            if (isYtReady) {
                const videoId = extractVideoId(data.link);
                ytPlayer.loadVideoById(videoId);
                ytPlayer.playVideo();
                playIcon.innerText = "pause";
            }
        }
    }

    function toggleMainPlay() {
        const playIcon = document.getElementById('play-icon');
        
        if (currentMode === 'local') {
            if (localAudio.paused) {
                localAudio.play();
                playIcon.innerText = "pause";
            } else {
                localAudio.pause();
                playIcon.innerText = "play_arrow";
            }
        } else {
            if (isYtReady) {
                const state = ytPlayer.getPlayerState();
                if (state === 1) { // Playing
                    ytPlayer.pauseVideo();
                    playIcon.innerText = "play_arrow";
                } else {
                    ytPlayer.playVideo();
                    playIcon.innerText = "pause";
                }
            }
        }
    }

    function onTrackUpdate() {
        if (currentMode === 'local' && localAudio.duration) {
            const pct = (localAudio.currentTime / localAudio.duration) * 100;
            document.getElementById('progress-fill').style.width = `${pct}%`;
        }
    }

    function onTrackEnded() {
        document.getElementById('play-icon').innerText = "play_arrow";
        document.getElementById('progress-fill').style.width = "0%";
    }

    function setVolume(val) {
        localAudio.volume = val / 100;
        if (isYtReady) ytPlayer.setVolume(val);
    }

    // Youtube Helpers
    function extractVideoId(url) {
        const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
        return (match && match[2].length == 11) ? match[2] : null;
    }

    // Load Youtube API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('yt-player-hidden', {
            height: '0', width: '0',
            events: {
                'onReady': () => { isYtReady = true; },
                'onStateChange': (event) => {
                    const playIcon = document.getElementById('play-icon');
                    if (currentMode === 'youtube') {
                        if (event.data === YT.PlayerState.PLAYING) playIcon.innerText = "pause";
                        else playIcon.innerText = "play_arrow";
                    }
                }
            }
        });
    }

    // ==========================================
    // 6. DASHBOARD LOGIC (SEARCH & CAMERA)
    // ==========================================
    async function performSearch() {
        const input = document.getElementById('search-input');
        const container = document.getElementById('recommendations-container');
        const query = input.value;

        if (!query.trim()) return;

        container.innerHTML = `<div class="text-center py-10 text-primary animate-pulse">Searching Youtube...</div>`;

        try {
            const res = await fetch(`/search?q=${encodeURIComponent(query)}&type=${encodeURIComponent(currentType)}`);
            const data = await res.json();

            if (!data.recommendations || data.recommendations.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-500">Không tìm thấy kết quả.</div>`;
                return;
            }
            
            container.innerHTML = data.recommendations.map(item => `
                <div class="glass-card p-3 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-white/5 transition-colors border border-transparent hover:border-white/10"
                     onclick='playTrack(${JSON.stringify(item)}, "youtube")'>
                    <img src="${item.thumbnail}" class="w-16 h-16 rounded-lg object-cover shadow-md">
                    <div class="min-w-0 flex-1">
                        <h4 class="font-bold text-sm text-white truncate leading-tight mb-1">${item.title}</h4>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">${currentType === 'podcast' ? 'Podcast' : 'Youtube Music'}</p>
                    </div>
                    <button class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white">
                        <span class="material-icons-round text-sm">play_arrow</span>
                    </button>
                </div>
            `).join('');
        } catch (e) {
            container.innerHTML = `<div class="text-center py-10 text-red-400">Search Failed.</div>`;
        }
    }

    // Camera Logic
    async function initCamera() {
        const video = document.getElementById('video');
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                video.srcObject = stream;
            } catch (err) {
                console.error("Camera access denied", err);
            }
        }
    }

    document.getElementById('analyze-btn').onclick = async () => {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const btn = document.getElementById('analyze-btn');
        const moodDisplay = document.getElementById('mood-display');
        const recContainer = document.getElementById('recommendations-container');

        btn.disabled = true;
        btn.innerHTML = `<span class="material-icons-round animate-spin">sync</span> SCANNING...`;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        canvas.toBlob(async (blob) => {
            const fd = new FormData();
            fd.append('file', blob, 'mood.jpg');

            try {
                const keyword = document.getElementById('search-input').value.trim();
                const recommendUrl = `/recommend?type=${encodeURIComponent(currentType)}${keyword ? `&q=${encodeURIComponent(keyword)}` : ''}`;
                const res = await fetch(recommendUrl, { method: 'POST', body: fd });
                const data = await res.json();

                moodDisplay.innerText = data.mood;
                moodDisplay.classList.add('text-primary');

                if (!data.recommendations || data.recommendations.length === 0) {
                    recContainer.innerHTML = `<div class="text-center py-10 text-slate-500">Không tìm thấy gợi ý phù hợp.</div>`;
                    return;
                }

                // Render Recommendations
                recContainer.innerHTML = data.recommendations.map(item => `
                    <div class="glass-card p-3 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-white/5 transition-colors border border-transparent hover:border-white/10"
                         onclick='playTrack(${JSON.stringify(item)}, "youtube")'>
                        <img src="${item.thumbnail}" class="w-16 h-16 rounded-lg object-cover shadow-md">
                        <div class="min-w-0 flex-1">
                            <h4 class="font-bold text-sm text-white truncate leading-tight mb-1">${item.title}</h4>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Mood: ${data.mood}</p>
                        </div>
                         <button class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white">
                            <span class="material-icons-round text-sm">play_arrow</span>
                        </button>
                    </div>
                `).join('');

            } catch (e) {
                console.error(e);
                alert("Mood Analysis Failed");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<span class="material-icons-round">face_retouching_natural</span> ANALYZE MOOD`;
            }
        }, 'image/jpeg');
    };

    // ==========================================
    // 7. INITIALIZATION
    // ==========================================
    window.addEventListener('DOMContentLoaded', initUI);

</script>
<script type="module">
    // --- FIREBASE AUTH (GOOGLE LOGIN/LOGOUT) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { 
        getAuth,
        onAuthStateChanged,
        signInWithPopup,
        GoogleAuthProvider,
        signOut
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDzBMntuhKIphik-AnRPbxGHZmUNnaEOA4",
        authDomain: "kietsound-fd3a8.firebaseapp.com",
        projectId: "kietsound-fd3a8",
        storageBucket: "kietsound-fd3a8.firebasestorage.app",
        messagingSenderId: "986477792759",
        appId: "1:986477792759:web:741aeb2393826b534a72f2",
        measurementId: "G-79N93EHL36"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById('login-btn');
    const userDisplay = document.getElementById('user-display');

    async function handleLoginLogout() {
        try {
            if (auth.currentUser) {
                await signOut(auth);
            } else {
                await signInWithPopup(auth, provider);
            }
        } catch (error) {
            console.error("Firebase auth error:", error);
            alert("Không thể đăng nhập. Vui lòng thử lại.");
        }
    }

    if (loginBtn) {
        loginBtn.addEventListener('click', handleLoginLogout);
    }

    onAuthStateChanged(auth, (user) => {
        if (!userDisplay || !loginBtn) return;

        if (user) {
            const label = user.email || user.displayName || "User";
            userDisplay.textContent = `Hi, ${label}`;
            loginBtn.textContent = "LOGOUT";
            loginBtn.classList.remove("bg-white/10");
            loginBtn.classList.add("bg-primary", "text-white");
        } else {
            userDisplay.textContent = "Guest";
            loginBtn.textContent = "LOGIN";
            loginBtn.classList.add("bg-white/10");
            loginBtn.classList.remove("bg-primary");
        }
    });
</script>
</body>
</html>