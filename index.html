<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Mood AI - Ultimate Dark Mode</title>
    
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#FF6F61", // Coral Orange
                        "background-dark": "#090A0C",
                        "card-dark": "rgba(23, 25, 30, 0.7)",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                        display: ["Outfit", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "1rem",
                        'xl': '1.25rem',
                        '2xl': '1.5rem',
                        '3xl': '2rem',
                    },
                },
            },
        };
    </script>
    <style type="text/tailwindcss">
        body {
            background-color: #090A0C;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(255, 111, 97, 0.08) 0%, transparent 40%), 
                radial-gradient(circle at 100% 100%, rgba(255, 111, 97, 0.08) 0%, transparent 40%);
            background-attachment: fixed;
        }

        /* Glassmorphism mới */
        .glass-card {
            background: rgba(23, 25, 30, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Hiệu ứng Scan trên Camera */
        .scan-line {
            height: 2px;
            background: linear-gradient(to right, transparent, #FF6F61, transparent);
            position: absolute;
            width: 100%;
            top: 0;
            animation: scan 4s linear infinite;
            z-index: 10;
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Animation xoay đĩa nhạc */
        .spin-slow { animation: spin 8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        /* Sliders (Seek & Volume) */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: #FF6F61; cursor: pointer; margin-top: -5px; 
            box-shadow: 0 0 15px rgba(255, 111, 97, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 3px; cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 10px;
        }
        #volume-slider::-webkit-slider-thumb { background: #cbd5e1; box-shadow: none; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-enter { animation: slideIn 0.3s forwards; }
    </style>
</head>
<body class="bg-background-dark text-slate-200 min-h-screen font-sans selection:bg-primary/30 relative overflow-x-hidden">

<div id="toast-container" class="fixed top-24 right-6 z-[60] flex flex-col gap-3 pointer-events-none"></div>

<div id="collection-modal" class="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
    <div class="glass-card w-full max-w-md rounded-3xl p-8 animate-fade-in shadow-2xl relative border border-white/10">
        <button onclick="closeCollectionModal()" class="absolute top-6 right-6 text-slate-400 hover:text-white transition-colors">
            <span class="material-icons-round">close</span>
        </button>
        
        <h3 class="text-2xl font-display font-bold text-white mb-2">Save to Collection</h3>
        <p class="text-sm text-slate-400 mb-6">Choose a playlist to save this track.</p>
        
        <div id="modal-collections-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar mb-6 pr-2">
            </div>

        <div class="pt-4 mt-2 border-t border-white/10">
            <div class="flex gap-3">
                <input id="new-collection-input" type="text" placeholder="New collection name..." class="flex-grow bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm focus:ring-1 focus:ring-primary focus:border-primary text-white placeholder-slate-500 transition-all">
                <button onclick="createNewCollectionInModal()" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-xl font-bold text-sm transition-all shadow-lg shadow-primary/20">
                    Create
                </button>
            </div>
        </div>
    </div>
</div>

<nav class="sticky top-0 z-50 px-6 py-4 glass-card border-b border-white/5 mb-8">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="bg-primary p-2 rounded-xl shadow-lg shadow-primary/30">
                <span class="material-icons-round text-white block">psychology</span>
            </div>
            <span class="text-xl font-display font-bold tracking-tight text-white uppercase">Mood <span class="text-primary">AI</span></span>
        </div>
        
        <div class="hidden md:flex items-center gap-1 bg-white/5 p-1 rounded-2xl border border-white/5">
            <button onclick="showView('dashboard')" id="nav-dashboard" class="px-6 py-2 rounded-xl text-sm font-semibold transition-all bg-white/10 text-white shadow-sm">Dashboard</button>
            <button onclick="showView('library')" id="nav-library" class="px-6 py-2 rounded-xl text-sm font-semibold text-slate-400 hover:text-white transition-all">Library</button>
        </div>

        <div class="flex items-center gap-4">
            <div class="h-10 w-10 rounded-full bg-gradient-to-tr from-primary to-orange-400 border-2 border-white/10 shadow-md flex items-center justify-center text-white font-bold text-sm">
                ME
            </div>
        </div>
    </div>
</nav>

<main class="max-w-7xl mx-auto px-6 pb-48">
    
    <div id="view-dashboard" class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start animate-fade-in">
        
        <section class="lg:col-span-5 space-y-6">
            <div class="relative group">
                <div class="aspect-[4/3] rounded-[2rem] overflow-hidden glass-card relative shadow-2xl border border-white/10">
                    <video id="video" autoplay playsinline class="w-full h-full object-cover opacity-80"></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                    
                    <div class="absolute inset-0 pointer-events-none overflow-hidden rounded-[2rem]">
                        <div class="scan-line"></div>
                    </div>

                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent flex flex-col justify-end p-8 pointer-events-none">
                        <div class="pointer-events-auto flex justify-center">
                            <button id="analyze-btn" class="bg-primary hover:bg-primary/90 text-white px-8 py-4 rounded-2xl font-bold flex items-center justify-center gap-3 transition-all transform hover:scale-[1.02] active:scale-95 shadow-xl shadow-primary/40 w-full">
                                <span class="material-icons-round">face</span>
                                ANALYZE MOOD
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card rounded-3xl p-8 shadow-xl border border-white/10">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Detected Emotion</p>
                        <h2 id="mood-display" class="text-4xl font-display font-bold text-white uppercase">WAITING...</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">Confidence</p>
                        <div class="flex items-center gap-2 justify-end">
                            <span id="confidence-text" class="text-2xl font-display font-bold text-primary">0%</span>
                        </div>
                    </div>
                </div>
                <div class="w-full h-3 bg-white/5 rounded-full overflow-hidden">
                    <div id="confidence-bar" class="h-full bg-primary w-0 transition-all duration-1000 ease-out shadow-[0_0_10px_#FF6F61]"></div>
                </div>
                <div class="mt-6 flex items-center gap-2 text-sm text-slate-400 italic">
                    <span class="material-icons-round text-sm text-primary">auto_awesome</span>
                    <span id="mood-description">Ready to scan your vibes...</span>
                </div>
            </div>
        </section>

        <section class="lg:col-span-7 space-y-8">
            
            <div class="glass-card rounded-3xl p-2 pl-6 shadow-lg flex items-center gap-4 border border-white/10 group focus-within:border-primary/50 transition-colors">
                <span class="material-icons-round text-slate-500 group-focus-within:text-primary transition-colors">search</span>
                <input id="search-input" class="flex-1 bg-transparent border-none focus:ring-0 text-lg font-medium placeholder:text-slate-600 text-white h-12" placeholder="Search artists, tracks, or mood..." type="text"/>
                <button id="search-btn" class="bg-white text-background-dark px-8 py-3 rounded-2xl font-bold text-sm hover:bg-slate-200 transition-colors shadow-lg">
                    GO
                </button>
            </div>

            <div>
                <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
                    <div>
                        <h3 class="text-2xl font-display font-bold text-white">Recommended</h3>
                        <p class="text-slate-400 text-sm">Tailored for your current state</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="tab-music" onclick="switchTab('music')" class="flex items-center gap-2 px-5 py-2.5 rounded-2xl bg-primary text-white font-semibold shadow-lg shadow-primary/20 transition-all">
                            <span class="material-icons-round text-lg">music_note</span> Music
                        </button>
                        <button id="tab-podcast" onclick="switchTab('podcast')" class="flex items-center gap-2 px-5 py-2.5 rounded-2xl bg-white/5 text-slate-400 font-semibold border border-white/5 hover:bg-white/10 hover:text-white transition-all">
                            <span class="material-icons-round text-lg">podcasts</span> Podcast
                        </button>
                    </div>
                </div>

                <div id="recommendations-container" class="space-y-3 max-h-[600px] overflow-y-auto custom-scrollbar pr-2">
                    <div class="glass-card rounded-[2rem] border-dashed border-2 border-white/10 p-12 flex flex-col items-center justify-center text-center space-y-4">
                        <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center text-slate-600 mb-2">
                            <span class="material-icons-round text-4xl">graphic_eq</span>
                        </div>
                        <div>
                            <p class="text-lg font-display font-semibold text-slate-300">No music yet</p>
                            <p class="text-sm text-slate-500">Scan your face or search to start listening.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="view-library" class="hidden animate-fade-in">
        <div class="flex flex-col md:flex-row gap-8 h-[calc(100vh-180px)]">
            
            <aside class="w-full md:w-1/3 lg:w-1/4 flex flex-col gap-4">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-2xl font-display font-bold text-white">Playlists</h2>
                    <button onclick="showCreateCollectionPrompt()" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-primary hover:text-white flex items-center justify-center transition-all border border-white/10">
                        <span class="material-icons-round">add</span>
                    </button>
                </div>
                <div id="collections-list" class="flex-grow overflow-y-auto custom-scrollbar space-y-3 pr-2">
                    </div>
            </aside>

            <div class="flex-1 glass-card rounded-[2.5rem] border border-white/10 p-8 flex flex-col bg-black/20">
                <div class="flex items-center justify-between mb-8 border-b border-white/5 pb-6">
                    <div>
                        <span class="text-xs font-bold text-primary uppercase tracking-widest">Current Playlist</span>
                        <h2 id="current-collection-title" class="text-4xl font-display font-bold text-white mt-2">Yêu thích chung</h2>
                    </div>
                    <button id="delete-collection-btn" onclick="deleteCurrentCollection()" class="hidden px-4 py-2 rounded-xl bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition-all text-sm font-bold">
                        Delete
                    </button>
                </div>
                
                <div id="library-container" class="grid grid-cols-1 xl:grid-cols-2 gap-4 overflow-y-auto custom-scrollbar pr-2 pb-24">
                    </div>
                
                <div id="empty-library-msg" class="text-center py-20 text-slate-600 hidden m-auto">
                    <span class="material-icons-round text-6xl opacity-20 mb-4">queue_music</span>
                    <p>This playlist is empty.</p>
                </div>
            </div>
        </div>
    </div>

</main>

<div id="youtube-player-hidden" class="absolute -top-[1000px]"></div>

<div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-5xl px-4 z-50">
    <div id="player-bar" class="glass-card p-4 pr-8 rounded-[2rem] shadow-2xl bg-[#090A0C]/90 border border-white/10 hidden backdrop-blur-xl">
        <div class="flex flex-col gap-4">
            <div class="flex items-center justify-between gap-6">
                
                <div class="flex items-center gap-5 flex-1 min-w-0">
                    <div class="w-14 h-14 rounded-full overflow-hidden flex-shrink-0 border-2 border-white/10 relative shadow-lg">
                        <img id="player-thumbnail" alt="Track" class="w-full h-full object-cover" src=""/>
                        <div class="absolute inset-0 bg-black/20 rounded-full"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-2 h-2 bg-white rounded-full"></div>
                        </div>
                    </div>
                    <div class="flex-grow min-w-0 hidden sm:block">
                        <p id="player-title" class="text-base font-display font-bold truncate text-white">Select a track</p>
                        <div class="flex items-center gap-2">
                            <p id="player-status" class="text-[10px] text-primary uppercase tracking-widest font-bold">Ready</p>
                            <div id="wave-animation" class="hidden flex gap-[3px] items-end h-3">
                                <span class="w-[3px] h-full bg-primary animate-pulse rounded-full"></span>
                                <span class="w-[3px] h-2/3 bg-primary animate-pulse delay-75 rounded-full"></span>
                                <span class="w-[3px] h-full bg-primary animate-pulse delay-150 rounded-full"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <button class="w-10 h-10 flex items-center justify-center hover:text-primary text-slate-400 transition-colors">
                        <span class="material-icons-round text-2xl">skip_previous</span>
                    </button>
                    <button id="player-play-btn" class="w-14 h-14 bg-white text-background-dark rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:scale-105 active:scale-95 transition-all">
                        <span id="play-icon" class="material-icons-round text-3xl">play_arrow</span>
                    </button>
                    <button class="w-10 h-10 flex items-center justify-center hover:text-primary text-slate-400 transition-colors">
                        <span class="material-icons-round text-2xl">skip_next</span>
                    </button>
                </div>

                <div class="flex items-center gap-6">
                    <div class="group flex items-center gap-3 bg-white/5 px-4 py-2 rounded-full border border-white/5 hover:bg-white/10 transition-all">
                        <button id="mute-btn" class="text-slate-400 hover:text-white flex items-center">
                            <span id="volume-icon" class="material-icons-round text-xl">volume_up</span>
                        </button>
                        <input id="volume-slider" type="range" min="0" max="100" value="100" class="w-20 h-1 cursor-pointer">
                    </div>

                    <div class="relative">
                        <button id="more-options-btn" class="w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition-colors">
                            <span class="material-icons-round">more_vert</span>
                        </button>
                        
                        <div id="options-menu" class="hidden absolute bottom-full right-0 mb-4 w-60 glass-card rounded-2xl shadow-2xl overflow-hidden animate-fade-in z-[100] border border-white/10 p-2">
                            <a id="open-youtube-link" href="#" target="_blank" class="flex items-center gap-3 px-4 py-3 hover:bg-white/10 rounded-xl text-sm font-medium text-slate-300 hover:text-white transition-colors">
                                <span class="material-icons-round text-lg text-red-500">smart_display</span>
                                Open in YouTube
                            </a>
                            <button id="open-collection-modal-btn" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/10 rounded-xl text-sm font-medium text-slate-300 hover:text-primary transition-colors text-left">
                                <span class="material-icons-round text-lg">playlist_add</span>
                                Add to Playlist
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4 text-[11px] font-bold text-slate-500 px-2">
                <span id="current-time">0:00</span>
                <input id="seek-bar" type="range" min="0" max="100" value="0" class="flex-grow h-1.5 bg-white/10 rounded-lg appearance-none cursor-pointer focus:outline-none">
                <span id="total-duration">0:00</span>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. BIẾN TOÀN CỤC & SELECTORS (KHÔNG ĐỔI) ---
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const analyzeBtn = document.getElementById('analyze-btn');
    const moodDisplay = document.getElementById('mood-display');
    const confidenceBar = document.getElementById('confidence-bar');
    const confidenceText = document.getElementById('confidence-text');
    const moodDescription = document.getElementById('mood-description');
    const recommendationsContainer = document.getElementById('recommendations-container');
    const playerBar = document.getElementById('player-bar');
    const tabMusic = document.getElementById('tab-music');
    const tabPodcast = document.getElementById('tab-podcast');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');

    // Player Elements
    const playerTitle = document.getElementById('player-title');
    const playerThumbnail = document.getElementById('player-thumbnail');
    const playerPlayBtn = document.getElementById('player-play-btn');
    const playIcon = document.getElementById('play-icon');
    const playerStatus = document.getElementById('player-status');
    const waveAnimation = document.getElementById('wave-animation');
    const seekBar = document.getElementById('seek-bar');
    const currentTimeEl = document.getElementById('current-time');
    const totalDurationEl = document.getElementById('total-duration');
    const moreOptionsBtn = document.getElementById('more-options-btn');
    const optionsMenu = document.getElementById('options-menu');
    const openYoutubeLink = document.getElementById('open-youtube-link');
    
    // Volume Elements
    const volumeSlider = document.getElementById('volume-slider');
    const muteBtn = document.getElementById('mute-btn');
    const volumeIcon = document.getElementById('volume-icon');

    // Collection Elements
    const openCollectionModalBtn = document.getElementById('open-collection-modal-btn');
    const collectionModal = document.getElementById('collection-modal');
    const modalCollectionsList = document.getElementById('modal-collections-list');
    const newCollectionInput = document.getElementById('new-collection-input');
    const collectionsListSidebar = document.getElementById('collections-list');
    const libraryContainer = document.getElementById('library-container');
    const emptyLibraryMsg = document.getElementById('empty-library-msg');
    const currentCollectionTitle = document.getElementById('current-collection-title');
    const deleteCollectionBtn = document.getElementById('delete-collection-btn');

    // Navigation Elements
    const navDashboard = document.getElementById('nav-dashboard');
    const navLibrary = document.getElementById('nav-library');
    const viewDashboard = document.getElementById('view-dashboard');
    const viewLibrary = document.getElementById('view-library');

    // State Variables
    let currentType = 'music';
    let ytPlayer; 
    let isPlayerReady = false;
    let isPlaying = false;
    let updateInterval;
    let currentTrackData = null; 
    let lastVolume = 100;

    // Load Collections from LocalStorage
    let collections = JSON.parse(localStorage.getItem('moodAiCollections')) || [
        { id: 'default', name: 'Yêu thích chung', items: [] }
    ];
    let activeCollectionId = 'default';

    const moodDescriptions = {
        "happy": "Radiating positive vibes! Here's some energy.", 
        "sad": "It's okay to feel down. Here's some healing.", 
        "angry": "High energy release incoming!", 
        "neutral": "Stay focused and calm.", 
        "fear": "Take a deep breath. Relaxing sounds for you.", 
        "surprise": "Something fresh and trending!", 
        "disgust": "Let it go with these tracks.",
        "manual": "Search results for your request."
    };

    // --- 2. SEARCH LOGIC ---
    searchBtn.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', (e) => { 
        if (e.key === 'Enter') performSearch(); 
    });

    async function performSearch() {
        const query = searchInput.value.trim();
        if (!query) return;

        recommendationsContainer.innerHTML = '<div class="text-center py-20 text-slate-400 animate-pulse"><p>Searching tone...</p></div>';
        moodDisplay.innerText = "SEARCH";
        moodDisplay.className = "text-4xl font-display font-bold text-primary uppercase italic";
        moodDescription.innerText = `Results for: ${query}`;
        confidenceBar.style.width = "0%";
        confidenceText.innerText = "";
        
        try {
            const response = await fetch(`http://127.0.0.1:8000/search?q=${encodeURIComponent(query)}&type=${currentType}`);
            const data = await response.json();
            renderRecommendations(data.recommendations);
        } catch (error) {
            console.error(error);
            recommendationsContainer.innerHTML = '<div class="text-center py-8 text-red-400"><p>Search connection failed.</p></div>';
        }
    }

    // --- 3. YOUTUBE API SETUP ---
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('youtube-player-hidden', {
            height: '0', 
            width: '0', 
            videoId: '',
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        isPlayerReady = true;
        ytPlayer.setVolume(100);
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            isPlaying = true;
            playIcon.innerText = "pause";
            playerThumbnail.classList.add("spin-slow");
            playerStatus.innerText = "Now Playing";
            waveAnimation.classList.remove("hidden");
            startProgressLoop();
        } else {
            isPlaying = false;
            playIcon.innerText = "play_arrow";
            playerThumbnail.classList.remove("spin-slow");
            playerStatus.innerText = event.data == YT.PlayerState.PAUSED ? "Paused" : "Finished";
            waveAnimation.classList.add("hidden");
            stopProgressLoop();
        }
    }

    // --- 4. PLAYER CONTROLS (Seek, Volume) ---
    function startProgressLoop() {
        stopProgressLoop();
        updateInterval = setInterval(() => {
            if (ytPlayer && isPlaying) {
                const currentTime = ytPlayer.getCurrentTime();
                const duration = ytPlayer.getDuration();
                if (duration > 0) {
                    seekBar.value = (currentTime / duration) * 100;
                    currentTimeEl.innerText = formatTime(currentTime);
                    totalDurationEl.innerText = formatTime(duration);
                }
            }
        }, 1000);
    }

    function stopProgressLoop() { 
        if (updateInterval) clearInterval(updateInterval); 
    }

    seekBar.addEventListener('input', () => {
        if (ytPlayer && isPlayerReady) {
            const duration = ytPlayer.getDuration();
            ytPlayer.seekTo((seekBar.value / 100) * duration, true);
        }
    });

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec < 10 ? '0' : ''}${sec}`;
    }

    // Volume Control Logic
    volumeSlider.addEventListener('input', (e) => {
        const val = e.target.value;
        if(ytPlayer && isPlayerReady) {
            ytPlayer.setVolume(val);
            if(val > 0) ytPlayer.unMute();
        }
        updateVolumeIcon(val);
        lastVolume = val;
    });

    muteBtn.addEventListener('click', () => {
        if(!ytPlayer || !isPlayerReady) return;
        if(ytPlayer.isMuted() || volumeSlider.value == 0) {
            ytPlayer.unMute();
            ytPlayer.setVolume(lastVolume || 50);
            volumeSlider.value = lastVolume || 50;
            updateVolumeIcon(lastVolume || 50);
        } else {
            lastVolume = volumeSlider.value;
            ytPlayer.mute();
            volumeSlider.value = 0;
            updateVolumeIcon(0);
        }
    });

    function updateVolumeIcon(val) {
        if(val == 0) volumeIcon.innerText = "volume_off";
        else if(val < 50) volumeIcon.innerText = "volume_down";
        else volumeIcon.innerText = "volume_up";
    }

    // --- 5. COLLECTION MANAGEMENT ---
    
    function saveCollections() {
        localStorage.setItem('moodAiCollections', JSON.stringify(collections));
    }

    // Render list inside Modal
    function renderModalCollections() {
        modalCollectionsList.innerHTML = '';
        collections.forEach(col => {
            const btn = document.createElement('button');
            btn.className = 'w-full text-left px-4 py-4 rounded-2xl bg-white/5 hover:bg-primary hover:text-white transition-all flex justify-between items-center group border border-white/5';
            btn.innerHTML = `
                <span class="font-bold text-sm truncate">${col.name}</span>
                <span class="text-xs text-slate-400 bg-black/20 px-2 py-1 rounded-md group-hover:text-white group-hover:bg-white/20">${col.items.length}</span>
            `;
            btn.onclick = () => addToCollection(col.id);
            modalCollectionsList.appendChild(btn);
        });
    }

    // Render Sidebar List
    function renderSidebarCollections() {
        collectionsListSidebar.innerHTML = '';
        collections.forEach(col => {
            const btn = document.createElement('button');
            const isActive = col.id === activeCollectionId;
            btn.className = `w-full text-left px-4 py-4 rounded-2xl transition-all flex items-center gap-3 border ${isActive ? 'bg-primary text-white shadow-lg shadow-primary/20 border-primary' : 'hover:bg-white/5 text-slate-400 border-transparent hover:border-white/5'}`;
            btn.innerHTML = `
                <span class="material-icons-round text-lg">${col.id === 'default' ? 'favorite' : 'queue_music'}</span>
                <span class="font-bold text-sm truncate flex-grow">${col.name}</span>
                ${isActive ? '' : `<span class="text-[10px] opacity-50 font-mono">${col.items.length}</span>`}
            `;
            btn.onclick = () => switchCollection(col.id);
            collectionsListSidebar.appendChild(btn);
        });
    }

    function switchCollection(id) {
        activeCollectionId = id;
        const col = collections.find(c => c.id === id);
        currentCollectionTitle.innerText = col.name;
        deleteCollectionBtn.classList.toggle('hidden', id === 'default');
        renderSidebarCollections();
        renderLibraryItems();
    }

    function renderLibraryItems() {
        const col = collections.find(c => c.id === activeCollectionId);
        libraryContainer.innerHTML = '';
        
        if (!col || col.items.length === 0) {
            emptyLibraryMsg.classList.remove('hidden');
            return;
        }
        emptyLibraryMsg.classList.add('hidden');

        col.items.forEach((item, index) => {
            const div = document.createElement('div');
            // CSS Merge: New card style
            div.className = 'group relative bg-white/5 rounded-3xl overflow-hidden hover:bg-white/10 transition-all flex items-center gap-4 p-3 pr-5 border border-white/5 cursor-pointer';
            div.innerHTML = `
                <div class="w-16 h-16 rounded-2xl overflow-hidden flex-shrink-0 relative">
                    <img src="${item.thumbnail}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                    <div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="material-icons-round text-white drop-shadow-lg">play_arrow</span>
                    </div>
                </div>
                <div class="flex-grow min-w-0">
                    <h5 class="font-bold text-sm text-slate-200 truncate group-hover:text-primary transition-colors">${item.title}</h5>
                    <p class="text-xs text-slate-500 font-medium">${item.duration || 'Audio'}</p>
                </div>
                <button onclick="event.stopPropagation(); removeFromCurrentCollection(${index})" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-500/20 text-slate-500 hover:text-red-400 transition-colors" title="Remove">
                    <span class="material-icons-round text-lg">delete_outline</span>
                </button>
            `;
            div.onclick = () => playTrackFromCollection(index);
            libraryContainer.appendChild(div);
        });
    }

    // Collection Actions
    openCollectionModalBtn.addEventListener('click', () => {
        if (!currentTrackData) return showToast('Play a track first!', 'info');
        renderModalCollections();
        collectionModal.classList.remove('hidden');
        optionsMenu.classList.add('hidden');
    });

    function closeCollectionModal() {
        collectionModal.classList.add('hidden');
    }

    function createNewCollectionInModal() {
        const name = newCollectionInput.value.trim();
        if (!name) return;
        collections.push({ id: Date.now().toString(), name: name, items: [] });
        saveCollections();
        newCollectionInput.value = '';
        renderModalCollections();
        renderSidebarCollections();
    }

    function showCreateCollectionPrompt() {
        const name = prompt("Enter new playlist name:");
        if (name) {
            collections.push({ id: Date.now().toString(), name: name, items: [] });
            saveCollections();
            renderSidebarCollections();
        }
    }

    function addToCollection(colId) {
        const col = collections.find(c => c.id === colId);
        if (!col) return;
        
        const exists = col.items.some(item => item.link === currentTrackData.link);
        if (exists) {
            showToast(`Already in "${col.name}"`, 'info');
        } else {
            col.items.push(currentTrackData);
            saveCollections();
            showToast(`Saved to "${col.name}"`, 'success');
            if (activeCollectionId === colId && !viewLibrary.classList.contains('hidden')) {
                renderSidebarCollections();
                renderLibraryItems();
            }
        }
        closeCollectionModal();
    }

    window.removeFromCurrentCollection = function(index) {
        const col = collections.find(c => c.id === activeCollectionId);
        if(col) {
            col.items.splice(index, 1);
            saveCollections();
            renderSidebarCollections();
            renderLibraryItems();
            showToast('Track removed', 'info');
        }
    };

    window.deleteCurrentCollection = function() {
        if (activeCollectionId === 'default') return;
        if(confirm("Delete this playlist permanently?")) {
            collections = collections.filter(c => c.id !== activeCollectionId);
            saveCollections();
            switchCollection('default');
            showToast('Playlist deleted', 'info');
        }
    };

    window.playTrackFromCollection = function(index) {
        const col = collections.find(c => c.id === activeCollectionId);
        if(col && col.items[index]) playTrack(col.items[index]);
    };

    // --- 6. UI HELPERS (Toast, Views, etc) ---
    moreOptionsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        optionsMenu.classList.toggle('hidden');
    });
    
    document.addEventListener('click', (e) => {
        if (!moreOptionsBtn.contains(e.target) && !optionsMenu.contains(e.target)) {
            optionsMenu.classList.add('hidden');
        }
        if (e.target === collectionModal) closeCollectionModal();
    });

    function showToast(msg, type='success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bg = type === 'success' ? 'bg-green-500' : 'bg-slate-700';
        toast.className = `pointer-events-auto flex items-center gap-3 px-6 py-4 rounded-2xl shadow-2xl text-white font-bold text-sm ${bg} toast-enter`;
        toast.innerHTML = `<span class="material-icons-round text-lg">${type==='success'?'check_circle':'info'}</span>${msg}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    window.showView = function(name) {
        if (name === 'dashboard') {
            viewDashboard.classList.remove('hidden');
            viewLibrary.classList.add('hidden');
            navDashboard.classList.add('bg-white/10', 'text-white', 'shadow-sm');
            navDashboard.classList.remove('text-slate-400');
            navLibrary.classList.remove('bg-white/10', 'text-white', 'shadow-sm');
            navLibrary.classList.add('text-slate-400');
        } else {
            viewDashboard.classList.add('hidden');
            viewLibrary.classList.remove('hidden');
            navLibrary.classList.add('bg-white/10', 'text-white', 'shadow-sm');
            navLibrary.classList.remove('text-slate-400');
            navDashboard.classList.remove('bg-white/10', 'text-white', 'shadow-sm');
            navDashboard.classList.add('text-slate-400');
            renderSidebarCollections();
            renderLibraryItems();
        }
    };

    function switchTab(type) {
        currentType = type;
        const activeClass = ['bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/20'];
        const inactiveClass = ['bg-white/5', 'text-slate-400', 'border', 'border-white/5'];
        
        if (type === 'music') {
            tabMusic.classList.add(...activeClass);
            tabMusic.classList.remove(...inactiveClass);
            tabPodcast.classList.remove(...activeClass);
            tabPodcast.classList.add(...inactiveClass);
        } else {
            tabPodcast.classList.add(...activeClass);
            tabPodcast.classList.remove(...inactiveClass);
            tabMusic.classList.remove(...activeClass);
            tabMusic.classList.add(...inactiveClass);
        }
        if(searchInput.value.trim()!=="") performSearch();
    }

    // --- 7. CAMERA & MAIN LOGIC ---
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({video: true});
            video.srcObject = stream;
        } catch (err) { alert("Camera Error: " + err); }
    }

    analyzeBtn.addEventListener('click', async () => {
        searchInput.value = "";
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        canvas.toBlob(async (blob) => { await sendToBackend(blob); }, 'image/jpeg');
    });

    async function sendToBackend(blob) {
        analyzeBtn.disabled = true;
        moodDisplay.innerText = "Scanning...";
        moodDisplay.className = "text-4xl font-display font-bold text-slate-400 uppercase italic animate-pulse";
        
        const formData = new FormData();
        formData.append('file', blob, 'capture.jpg');
        const url = new URL('http://127.0.0.1:8000/recommend');
        url.searchParams.append('type', currentType);

        try {
            const response = await fetch(url, { method: 'POST', body: formData });
            const data = await response.json();
            displayMood(data.mood);
            renderRecommendations(data.recommendations);
        } catch (error) {
            console.error(error);
            moodDisplay.innerText = "Error!";
        } finally {
            analyzeBtn.disabled = false;
        }
    }

    function displayMood(mood) {
        const colors = {
            "happy": "text-green-400", "sad": "text-blue-400", 
            "angry": "text-red-500", "neutral": "text-slate-400", 
            "fear": "text-purple-400", "surprise": "text-yellow-400", 
            "disgust": "text-orange-400"
        };
        moodDisplay.innerText = mood.toUpperCase();
        moodDisplay.className = `text-4xl font-display font-bold uppercase italic ${colors[mood] || "text-slate-400"}`;
        moodDescription.innerText = moodDescriptions[mood] || "Your mood detected";
        confidenceBar.style.width = "85%";
        confidenceText.innerText = "85%";
    }

    function renderRecommendations(items) {
        recommendationsContainer.innerHTML = "";
        if (!items || items.length === 0) {
            recommendationsContainer.innerHTML = '<div class="text-center py-8 text-slate-400"><p>No results found.</p></div>';
            return;
        }

        items.forEach((item) => {
            const div = document.createElement('div');
            // Updated Card Style
            div.className = 'group glass-card rounded-3xl p-3 pr-6 flex items-center gap-4 hover:bg-white/5 transition-all cursor-pointer border-transparent hover:border-primary/30';
            
            div.innerHTML = `
                <div class="relative w-20 h-20 flex-shrink-0 rounded-2xl overflow-hidden group-hover:scale-105 transition-transform">
                    <img class="w-full h-full object-cover" src="${item.thumbnail || 'https://via.placeholder.com/80'}"/>
                    <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="material-icons-round text-white text-3xl drop-shadow-lg">play_arrow</span>
                    </div>
                </div>
                <div class="flex-grow min-w-0">
                    <h4 class="font-bold text-base text-slate-200 truncate group-hover:text-primary transition-colors">${item.title}</h4>
                    <p class="text-xs text-slate-500 font-medium uppercase tracking-wide mt-1">${item.duration || 'N/A'}</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="material-icons-round text-slate-400 text-sm">arrow_forward</span>
                </div>
            `;
            
            div.addEventListener('click', () => { playTrack(item); });
            recommendationsContainer.appendChild(div);
        });
    }

    function playTrack(item) {
        currentTrackData = item;
        playerBar.classList.remove('hidden');
        playerTitle.innerText = item.title;
        playerThumbnail.src = item.thumbnail;
        openYoutubeLink.href = item.link;

        let videoId = "";
        try {
            if (item.link.includes("v=")) {
                videoId = item.link.split('v=')[1].split('&')[0];
            } else if (item.link.includes("youtu.be/")) {
                videoId = item.link.split('youtu.be/')[1];
            }
        } catch(e) { console.error("Link parsing error", e); }

        if (videoId && ytPlayer && isPlayerReady) {
            ytPlayer.loadVideoById(videoId);
        } else {
            window.open(item.link, '_blank');
        }
    }

    // Controls Event Listeners
    playerPlayBtn.addEventListener('click', () => {
        if (!isPlayerReady) return;
        isPlaying ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
    });

    // Start App
    startCamera();
</script>
</body>
</html>